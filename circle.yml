machine:
  pre:
    - wget https://storage.googleapis.com/golang/go1.5.3.linux-amd64.tar.gz
    - tar zxvf go1.5.3.linux-amd64.tar.gz
    - |
      sudo curl -L -o /usr/bin/docker 'http://s3-external-1.amazonaws.com/circle-downloads/docker-1.8.1-circleci'
      sudo chmod 0755 /usr/bin/docker
      sudo service docker start
  environment:
    GOROOT: ${HOME}/go
    PATH: ${GOROOT}/bin:${PATH}
    GO15VENDOREXPERIMENT: "1"
    IMPORT_PATH: "github.com/$CIRCLE_PROJECT_USERNAME/$CIRCLE_PROJECT_REPONAME"
  post:
    - go version

dependencies:
  pre:
    - go version
    - go get github.com/alecthomas/gometalinter
    - go get github.com/axw/gocov/gocov # https://github.com/golang/go/issues/6909
#    - go get github.com/mattn/goveralls
    - git describe --tags |tee VERSION
  override:
    - 'mkdir -p "$(echo "$GOPATH" | cut -d: -f1)/src/$IMPORT_PATH"'
    - 'rsync -avzC --delete ./ "$(echo "$GOPATH" | cut -d: -f1)/src/$IMPORT_PATH/"'

test:
  override:
    - 'cd "$(echo "$GOPATH" | cut -d: -f1)/src/$IMPORT_PATH"; go build .'
    - 'cd "$(echo "$GOPATH" | cut -d: -f1)/src/$IMPORT_PATH"; go test $(go list ./... | grep -v /vendor/)'
#    - gometalinter --cyclo-over=12 --tests --deadline=120s ./...
#    - gocov test ./... -short -timeout=5m > cov.json
#    - godep go test -v -timeout=5m ./...
#    - godep go test -v -short -race -timeout=5m ./...
#  post:
#    - goveralls -service=circleci -gocovdata=cov.json -repotoken=$COVERALLS_REPO_TOKEN || true

deployment:
  production:
    branch: master
    commands:
      - 'cd "$(echo "$GOPATH" | cut -d: -f1)/src/$IMPORT_PATH"; docker build -t kubermatic/api .'
      - docker login -e $DOCKER_EMAIL -u $DOCKER_USER -p $DOCKER_PASS
      - docker push kubermatic/api
